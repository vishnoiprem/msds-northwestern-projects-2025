---
title: "Framingham Heart Study Data Analysis - Assignment 4"
author: "Prem Vishnoi"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width = 10, fig.height = 6)
```

# Introduction

This analysis examines the Framingham Heart Study dataset, focusing on cardiovascular disease risk factors and outcomes. The Framingham Heart Study is one of the longest-running epidemiological studies, beginning in 1948.

## Load Required Libraries

```{r libraries}
library(readxl)    # For reading Excel files
library(dplyr)     # Data manipulation
library(ggplot2)   # Visualization
library(corrplot)  # Correlation plots
library(tidyr)     # Data tidying
library(knitr)     # For nice tables
library(gridExtra) # For arranging plots
```

## Load the Clean Dataset

```{r load-data}
# Load the prepared dataset
mydata <- readRDS("FHS_assign4_prem_vishnoi.rds")

# Display dimensions
cat("Dataset dimensions:", dim(mydata), "\n")
cat("Rows:", nrow(mydata), "| Columns:", ncol(mydata), "\n")
```

---

# Section 1: Data Overview

## Dataset Structure

```{r data-structure}
# Display structure
str(mydata)
```

## Summary Statistics

```{r summary-stats}
# Summary of key variables
summary(mydata[, c("age", "sex", "sysbp", "diabp", "bmi", "totchol", 
                   "cursmoke", "diabetes")])
```

## Variable Names

```{r variable-names}
# List all variable names
cat("Variables in the dataset:\n")
print(names(mydata))
```

---

# Section 2: Descriptive Statistics

## Demographic Variables

```{r demographics}
# Age distribution
cat("Age Statistics:\n")
cat("  Mean:", round(mean(mydata$age, na.rm = TRUE), 1), "years\n")
cat("  Median:", round(median(mydata$age, na.rm = TRUE), 1), "years\n")
cat("  Range:", paste(range(mydata$age, na.rm = TRUE), collapse = "-"), "years\n")

# Sex distribution
cat("\nSex Distribution:\n")
sex_table <- table(mydata$sex)
print(sex_table)
cat("  Proportion:\n")
cat("    Male (1):", round(prop.table(sex_table)[1] * 100, 1), "%\n")
cat("    Female (2):", round(prop.table(sex_table)[2] * 100, 1), "%\n")
```

## Clinical Variables

```{r clinical-vars}
# Blood pressure
cat("Blood Pressure Statistics:\n")
cat("  Systolic BP - Mean:", round(mean(mydata$sysbp, na.rm = TRUE), 1), 
    "mmHg | SD:", round(sd(mydata$sysbp, na.rm = TRUE), 1), "mmHg\n")
cat("  Diastolic BP - Mean:", round(mean(mydata$diabp, na.rm = TRUE), 1), 
    "mmHg | SD:", round(sd(mydata$diabp, na.rm = TRUE), 1), "mmHg\n")

# BMI
cat("\nBMI Statistics:\n")
cat("  Mean:", round(mean(mydata$bmi, na.rm = TRUE), 1), 
    "kg/m² | SD:", round(sd(mydata$bmi, na.rm = TRUE), 1), "kg/m²\n")
cat("  Range:", paste(round(range(mydata$bmi, na.rm = TRUE), 1), collapse = "-"), "kg/m²\n")

# Cholesterol
cat("\nTotal Cholesterol:\n")
cat("  Mean:", round(mean(mydata$totchol, na.rm = TRUE), 1), 
    "mg/dL | SD:", round(sd(mydata$totchol, na.rm = TRUE), 1), "mg/dL\n")
```

---

# Section 3: Data Visualization

## Age Distribution

```{r age-histogram}
ggplot(mydata, aes(x = age)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white") +
  labs(title = "Distribution of Age",
       x = "Age (years)",
       y = "Frequency") +
  theme_minimal()
```

## Blood Pressure Distribution

```{r bp-plots, fig.height=5}
p1 <- ggplot(mydata, aes(x = sysbp)) +
  geom_histogram(bins = 30, fill = "coral", color = "white") +
  labs(title = "Systolic Blood Pressure", x = "SBP (mmHg)", y = "Count") +
  theme_minimal()

p2 <- ggplot(mydata, aes(x = diabp)) +
  geom_histogram(bins = 30, fill = "lightblue", color = "white") +
  labs(title = "Diastolic Blood Pressure", x = "DBP (mmHg)", y = "Count") +
  theme_minimal()

grid.arrange(p1, p2, ncol = 2)
```

## BMI Distribution by Sex

```{r bmi-by-sex}
ggplot(mydata, aes(x = factor(sex), y = bmi, fill = factor(sex))) +
  geom_boxplot() +
  scale_fill_manual(values = c("steelblue", "coral"),
                    labels = c("Male", "Female")) +
  labs(title = "BMI Distribution by Sex",
       x = "Sex",
       y = "BMI (kg/m²)",
       fill = "Sex") +
  theme_minimal()
```

---

# Section 4: Correlation Analysis

## Select Key Clinical Variables for Correlation

```{r select-numeric}
# Select key continuous clinical variables for correlation
# Exclude ID, categorical factors, and variables with too much missing data
key_clinical_vars <- mydata %>%
  select(age, sysbp, diabp, bmi, totchol, heartrte, glucose) %>%
  # Only keep rows with complete data for these variables
  filter(complete.cases(.))

cat("Clinical variables for correlation:\n")
print(names(key_clinical_vars))
cat("\nComplete cases for correlation:", nrow(key_clinical_vars), "\n")
```

## Correlation Matrix

```{r correlation-matrix}
# Calculate correlation matrix
cor_matrix <- cor(key_clinical_vars, use = "complete.obs")

# Display correlation matrix
kable(round(cor_matrix, 3), caption = "Correlation Matrix of Clinical Variables")
```

## Correlation Heatmap

```{r correlation-plot, fig.height=7, fig.width=8}
corrplot(cor_matrix, 
         method = "color",
         type = "upper",
         tl.cex = 0.8,
         tl.col = "black",
         addCoef.col = "black",
         number.cex = 0.7,
         title = "Correlation Matrix of Clinical Variables",
         mar = c(0,0,2,0))
```

---

# Section 5: Risk Factor Analysis

## Prevalence of Risk Factors

```{r risk-factors}
cat("Risk Factor Prevalence:\n\n")

cat("Current Smokers:\n")
cat("  Count:", sum(mydata$cursmoke == 1, na.rm = TRUE), "\n")
cat("  Prevalence:", round(mean(mydata$cursmoke == 1, na.rm = TRUE) * 100, 1), "%\n\n")

cat("Diabetes:\n")
cat("  Count:", sum(mydata$diabetes == 1, na.rm = TRUE), "\n")
cat("  Prevalence:", round(mean(mydata$diabetes == 1, na.rm = TRUE) * 100, 1), "%\n\n")

if("bpmeds" %in% names(mydata)) {
  cat("On BP Medication:\n")
  cat("  Count:", sum(mydata$bpmeds == 1, na.rm = TRUE), "\n")
  cat("  Prevalence:", round(mean(mydata$bpmeds == 1, na.rm = TRUE) * 100, 1), "%\n\n")
}
```

## Smoking by Sex

```{r smoking-by-sex}
smoking_sex <- table(Sex = factor(mydata$sex, labels = c("Male", "Female")),
                     Smoker = factor(mydata$cursmoke, labels = c("No", "Yes")))

cat("Smoking Status by Sex:\n")
print(smoking_sex)
cat("\nProportions:\n")
print(round(prop.table(smoking_sex, 1) * 100, 1))

# Visualize
smoking_data <- as.data.frame(smoking_sex)
ggplot(smoking_data, aes(x = Sex, y = Freq, fill = Smoker)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Smoking Status by Sex",
       y = "Proportion",
       fill = "Smoker") +
  theme_minimal()
```

---

# Section 6: Outcome Variable Analysis

## CVD/CHD Outcomes

```{r outcome-analysis}
cat("Cardiovascular Outcomes:\n\n")

outcome_vars <- c("anychd", "mi_fchd", "hospmi", "angina", "stroke", "cvd", "death")

for(var in outcome_vars) {
  if(var %in% names(mydata)) {
    cat(var, ":\n")
    cases <- sum(mydata[[var]] == 1, na.rm = TRUE)
    total <- sum(!is.na(mydata[[var]]))
    prev <- mean(mydata[[var]] == 1, na.rm = TRUE) * 100
    cat("  Cases:", cases, "/", total, "\n")
    cat("  Prevalence:", round(prev, 1), "%\n\n")
  }
}
```

## CVD by Age Group

```{r cvd-by-age}
# Create age groups
mydata$age_group <- cut(mydata$age, 
                        breaks = c(0, 40, 50, 60, 70, 100),
                        labels = c("<40", "40-50", "50-60", "60-70", "70+"))

# CVD by age group
cvd_by_age <- mydata %>%
  group_by(age_group) %>%
  summarise(
    n = n(),
    cvd_cases = sum(cvd == 1, na.rm = TRUE),
    prevalence = round(mean(cvd == 1, na.rm = TRUE) * 100, 1)
  )

print(kable(cvd_by_age, digits = 1, 
            caption = "CVD Prevalence by Age Group"))

# Visualize
ggplot(cvd_by_age, aes(x = age_group, y = prevalence)) +
  geom_bar(stat = "identity", fill = "darkred") +
  geom_text(aes(label = paste0(prevalence, "%")), vjust = -0.5) +
  labs(title = "CVD Prevalence by Age Group",
       x = "Age Group",
       y = "Prevalence (%)") +
  theme_minimal()
```

---

# Section 7: Risk Factor Comparisons

## Blood Pressure and CVD

```{r bp-cvd}
ggplot(mydata, aes(x = factor(cvd), y = sysbp, fill = factor(cvd))) +
  geom_boxplot() +
  scale_fill_manual(values = c("lightblue", "coral"),
                    labels = c("No CVD", "CVD")) +
  labs(title = "Systolic BP by CVD Status",
       x = "CVD Status",
       y = "Systolic BP (mmHg)",
       fill = "Status") +
  theme_minimal()
```

## BMI and Cardiovascular Outcomes

```{r bmi-outcomes}
# BMI categories
mydata$bmi_category <- cut(mydata$bmi,
                            breaks = c(0, 18.5, 25, 30, 100),
                            labels = c("Underweight", "Normal", 
                                     "Overweight", "Obese"))

bmi_cvd <- mydata %>%
  filter(!is.na(bmi_category) & !is.na(cvd)) %>%
  group_by(bmi_category) %>%
  summarise(
    n = n(),
    cvd_cases = sum(cvd == 1, na.rm = TRUE),
    prevalence = round(mean(cvd == 1, na.rm = TRUE) * 100, 1)
  )

print(kable(bmi_cvd, digits = 1,
            caption = "CVD by BMI Category"))

# Visualize
ggplot(bmi_cvd, aes(x = bmi_category, y = prevalence)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = paste0(prevalence, "%")), vjust = -0.5) +
  labs(title = "CVD Prevalence by BMI Category",
       x = "BMI Category",
       y = "Prevalence (%)") +
  theme_minimal()
```

---

# Section 8: Statistical Tests

## T-test: Age by CVD Status

```{r t-test-age}
# T-test
t_result <- t.test(age ~ cvd, data = mydata)

cat("T-test: Age by CVD Status\n")
cat("  Mean age (No CVD):", round(mean(mydata$age[mydata$cvd == 0], na.rm = TRUE), 1), "years\n")
cat("  Mean age (CVD):", round(mean(mydata$age[mydata$cvd == 1], na.rm = TRUE), 1), "years\n")
cat("  Difference:", round(mean(mydata$age[mydata$cvd == 1], na.rm = TRUE) - 
                           mean(mydata$age[mydata$cvd == 0], na.rm = TRUE), 1), "years\n")
cat("  t-statistic:", round(t_result$statistic, 3), "\n")
cat("  p-value:", format(t_result$p.value, scientific = TRUE, digits = 3), "\n")

if(t_result$p.value < 0.001) {
  cat("  Result: Highly significant difference (p < 0.001)\n")
} else if(t_result$p.value < 0.05) {
  cat("  Result: Significant difference (p < 0.05)\n")
} else {
  cat("  Result: No significant difference (p >= 0.05)\n")
}
```

## Chi-Square: Sex and Diabetes

```{r chi-square}
# Contingency table
cont_table <- table(Sex = factor(mydata$sex, labels = c("Male", "Female")),
                   Diabetes = factor(mydata$diabetes, labels = c("No", "Yes")))
print(cont_table)

# Chi-square test
chi_result <- chisq.test(cont_table)

cat("\nChi-Square Test: Sex vs Diabetes\n")
cat("  Chi-square statistic:", round(chi_result$statistic, 3), "\n")
cat("  p-value:", round(chi_result$p.value, 4), "\n")

if(chi_result$p.value < 0.05) {
  cat("  Result: Significant association (p < 0.05)\n")
} else {
  cat("  Result: No significant association (p >= 0.05)\n")
}
```

---

# Section 9: Simple Linear Regression

## Predicting Systolic BP from Age

```{r regression-age-sbp}
# Fit model
model1 <- lm(sysbp ~ age, data = mydata)

# Display results
cat("Linear Regression: SBP ~ Age\n")
print(summary(model1))

# Visualize
ggplot(mydata, aes(x = age, y = sysbp)) +
  geom_point(alpha = 0.3, color = "steelblue") +
  geom_smooth(method = "lm", color = "red", se = TRUE) +
  labs(title = "Systolic BP vs Age",
       subtitle = paste0("R² = ", round(summary(model1)$r.squared, 3)),
       x = "Age (years)",
       y = "Systolic BP (mmHg)") +
  theme_minimal()
```

**Interpretation:**
- For each 1-year increase in age, systolic BP increases by approximately `r round(coef(model1)[2], 2)` mmHg
- R² = `r round(summary(model1)$r.squared, 3)` (age explains `r round(summary(model1)$r.squared * 100, 1)`% of the variance in SBP)

---

# Section 10: Multiple Regression

## Predicting Systolic BP from Multiple Factors

```{r multiple-regression}
# Fit multiple regression model
model2 <- lm(sysbp ~ age + bmi + factor(sex) + cursmoke + diabetes, data = mydata)

cat("Multiple Regression: SBP ~ Age + BMI + Sex + Smoking + Diabetes\n")
print(summary(model2))

# Confidence intervals
cat("\nConfidence Intervals:\n")
print(confint(model2))
```

**Key Findings:**
- Adjusted R² = `r round(summary(model2)$adj.r.squared, 3)`
- All predictors combined explain `r round(summary(model2)$adj.r.squared * 100, 1)`% of SBP variance

---

# Section 11: Logistic Regression

## Predicting CVD Risk

```{r logistic-regression}
# Fit logistic regression
logit_model <- glm(cvd ~ age + sysbp + bmi + factor(sex) + cursmoke + diabetes, 
                   data = mydata, 
                   family = binomial(link = "logit"))

cat("Logistic Regression: CVD ~ Age + SBP + BMI + Sex + Smoking + Diabetes\n")
print(summary(logit_model))

# Odds ratios
cat("\nOdds Ratios:\n")
or_table <- data.frame(
  Variable = names(coef(logit_model)),
  OR = round(exp(coef(logit_model)), 3)
)
print(or_table)

# 95% CI for odds ratios
cat("\n95% CI for Odds Ratios:\n")
print(round(exp(confint(logit_model)), 3))
```

**Interpretation:**
- Odds ratios > 1 indicate increased CVD risk
- Odds ratios < 1 indicate decreased CVD risk

---

# Conclusions

## Key Findings

1. **Dataset Characteristics**: 
   - Sample size: `r nrow(mydata)` participants
   - Age range: `r min(mydata$age)` to `r max(mydata$age)` years
   - CVD prevalence: `r round(mean(mydata$cvd) * 100, 1)`%

2. **Risk Factors**: 
   - Smoking prevalence: `r round(mean(mydata$cursmoke) * 100, 1)`%
   - Diabetes prevalence: `r round(mean(mydata$diabetes) * 100, 1)`%
   - Age and blood pressure are positively correlated (r = `r round(cor(mydata$age, mydata$sysbp, use="complete.obs"), 2)`)

3. **Statistical Relationships**: 
   - Age is significantly associated with CVD (p < 0.001)
   - CVD prevalence increases with age group
   - Multiple risk factors contribute to elevated blood pressure

4. **Model Performance**: 
   - Age alone explains ~`r round(summary(model1)$r.squared * 100, 0)`% of SBP variance
   - Multiple predictors improve model fit (R² = `r round(summary(model2)$r.squared, 2)`)

## Limitations

- Cross-sectional analysis limits causal inference
- Missing data in some variables (BMI, glucose, heart rate)
- Historical cohort may not reflect current population

## Future Directions

- Longitudinal analysis with follow-up data (time points 2 & 3)
- Investigation of interaction effects between risk factors
- Development of risk prediction models
- Stratified analyses by age and sex groups

---

# Session Information

```{r session-info}
sessionInfo()
```
